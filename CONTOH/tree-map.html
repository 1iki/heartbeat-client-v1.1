<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tree Mapping - Dependency Graph</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      /* Dark Theme */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-hover: #475569;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --shadow: rgba(0, 0, 0, 0.5);
      --accent-primary: #3b82f6;
      --accent-success: #10b981;
      --accent-danger: #ef4444;
      --accent-warning: #f59e0b;
      --accent-info: #8b5cf6;
      --gradient-primary: linear-gradient(135deg, #3b82f6, #8b5cf6);
      --gradient-success: linear-gradient(135deg, #10b981, #059669);
      --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
    }

    [data-theme="light"] {
      /* Light Theme */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-hover: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.08);
      --accent-primary: #2563eb;
      --accent-success: #059669;
      --accent-danger: #dc2626;
      --accent-warning: #d97706;
      --accent-info: #7c3aed;
      --gradient-primary: linear-gradient(135deg, #2563eb, #7c3aed);
      --gradient-success: linear-gradient(135deg, #059669, #047857);
      --gradient-danger: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      padding: 20px 32px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 100;
    }

    .header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-icon {
      width: 48px;
      height: 48px;
      background: var(--gradient-primary);
      border-radius: 12px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      padding-top: 8px;
    }

    .header-content h1 {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .header-subtitle {
      color: var(--text-secondary);
      font-size: 0.813rem;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 4px var(--shadow);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .connection-badge {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 2px solid var(--border-color);
    }

    .connection-badge.connected {
      background: color-mix(in srgb, var(--accent-success) 10%, transparent);
      color: var(--accent-success);
      border-color: var(--accent-success);
    }

    .connection-badge.disconnected {
      background: color-mix(in srgb, var(--accent-danger) 10%, transparent);
      color: var(--accent-danger);
      border-color: var(--accent-danger);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    /* Main Container */
    .main-container {
      display: flex;
      height: calc(100vh - 88px);
      position: relative;
    }

    /* Graph Container */
    .graph-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: var(--bg-primary);
    }

    #tree-graph {
      width: 100%;
      height: 100%;
    }

    /* Legend */
    .legend {
      position: absolute;
      top: 20px;
      left: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 10;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 240px;
    }

    .legend.open {
      max-height: 500px;
      opacity: 1;
      padding: 16px;
    }

    .legend-title {
      font-size: 0.875rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 0.813rem;
      color: var(--text-secondary);
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Stats Panel */
    .stats-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 10;
      min-width: 200px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stats-panel.open {
      max-height: 500px;
      opacity: 1;
      padding: 16px;
    }

    .stats-panel-title {
      font-size: 0.875rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.813rem;
    }

    .stat-label {
      color: var(--text-secondary);
    }

    .stat-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Icon Buttons */
    .icon-buttons {
      position: absolute;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 20;
    }

    .icon-buttons.top-left {
      top: 20px;
      left: 20px;
    }

    .icon-buttons.top-right {
      top: 20px;
      right: 20px;
    }

    .icon-buttons.bottom-left {
      bottom: 20px;
      left: 20px;
    }

    .icon-btn {
      width: 48px;
      height: 48px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px var(--shadow);
      position: relative;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .icon-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-secondary);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.3s ease;
    }

    .icon-btn:hover svg,
    .icon-btn.active svg {
      stroke: var(--accent-primary);
    }

    .icon-btn.active svg {
      stroke: white;
    }

    /* Tooltip for icons */
    .icon-tooltip {
      position: absolute;
      left: 60px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 2px 8px var(--shadow);
      z-index: 100;
    }

    .icon-btn:hover .icon-tooltip {
      opacity: 1;
    }

    /* Side Panel (Drawer) */
    .side-panel {
      position: absolute;
      right: -420px;
      top: 0;
      bottom: 0;
      width: 420px;
      background: var(--bg-secondary);
      border-left: 2px solid var(--border-color);
      box-shadow: -4px 0 12px var(--shadow);
      transition: right 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 50;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side-panel.open {
      right: 0;
    }

    .side-panel-header {
      background: var(--bg-tertiary);
      padding: 24px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .side-panel-title {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    .close-btn {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      font-size: 1.25rem;
      font-weight: bold;
    }

    .close-btn:hover {
      background: var(--accent-danger);
      color: white;
      border-color: var(--accent-danger);
      transform: rotate(90deg);
    }

    .side-panel-body {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section-title {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-item {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 8px;
    }

    .detail-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 0.938rem;
      font-weight: 600;
      color: var(--text-primary);
      word-break: break-word;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 800;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-UP { 
      background: color-mix(in srgb, var(--accent-success) 20%, transparent); 
      color: var(--accent-success);
      border: 1px solid var(--accent-success);
    }

    .status-DOWN { 
      background: color-mix(in srgb, var(--accent-danger) 20%, transparent); 
      color: var(--accent-danger);
      border: 1px solid var(--accent-danger);
    }

    .status-TIMEOUT { 
      background: color-mix(in srgb, var(--accent-warning) 20%, transparent); 
      color: var(--accent-warning);
      border: 1px solid var(--accent-warning);
    }

    .status-UNKNOWN { 
      background: color-mix(in srgb, var(--text-muted) 20%, transparent); 
      color: var(--text-muted);
      border: 1px solid var(--text-muted);
    }

    /* Tooltip */
    .node-tooltip {
      position: absolute;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.813rem;
      color: var(--text-primary);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1000;
      box-shadow: 0 4px 12px var(--shadow);
      max-width: 250px;
    }

    .node-tooltip.visible {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .tooltip-status {
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .tooltip-url {
      font-size: 0.7rem;
      color: var(--text-muted);
      word-break: break-all;
    }

    /* Controls */
    .controls-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 10;
      display: flex;
      gap: 12px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .controls-panel.open {
      max-height: 100px;
      opacity: 1;
      padding: 16px;
    }

    .control-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }

    .control-btn:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .side-panel {
        width: 100%;
        right: -100%;
      }

      .legend, .stats-panel, .controls-panel {
        font-size: 0.75rem;
        padding: 12px;
      }
    }

    /* Loading */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      z-index: 1000;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div class="header-icon">üå≥</div>
      <div>
        <h1>Tree Mapping - Dependency Graph</h1>
        <p class="header-subtitle">Visualisasi hierarkis status monitoring real-time</p>
      </div>
    </div>
    <div class="header-actions">
      <div id="connectionStatus" class="connection-badge disconnected">
        <span class="status-dot"></span>
        Terputus
      </div>
      <button class="btn btn-secondary" onclick="window.location.href='/'">
        ‚Üê Dashboard
      </button>
      <button class="btn btn-primary" onclick="resetZoom()">
        üîÑ Reset View
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Memuat dependency graph...</div>
    </div>

    <!-- Graph Container -->
    <div class="graph-container">
      <svg id="tree-graph"></svg>

      <!-- Icon Buttons - Top Left -->
      <div class="icon-buttons top-left">
        <div class="icon-btn" onclick="toggleLegend()" id="legendBtn">
          <svg viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
            <line x1="14" y1="6.5" x2="21" y2="6.5"/>
            <line x1="14" y1="17.5" x2="21" y2="17.5"/>
          </svg>
          <div class="icon-tooltip">Legend</div>
        </div>
      </div>

      <!-- Icon Buttons - Top Right -->
      <div class="icon-buttons top-right">
        <div class="icon-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
          <svg viewBox="0 0 24 24" id="fullscreenIcon">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
          <div class="icon-tooltip">Fullscreen</div>
        </div>
        <div class="icon-btn" onclick="toggleStats()" id="statsBtn">
          <svg viewBox="0 0 24 24">
            <line x1="12" y1="20" x2="12" y2="10"/>
            <line x1="18" y1="20" x2="18" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="16"/>
          </svg>
          <div class="icon-tooltip" style="left: auto; right: 60px;">Statistics</div>
        </div>
      </div>

      <!-- Icon Buttons - Bottom Left -->
      <div class="icon-buttons bottom-left">
        <div class="icon-btn" onclick="toggleControls()" id="controlsBtn">
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="1"/>
            <circle cx="12" cy="5" r="1"/>
            <circle cx="12" cy="19" r="1"/>
          </svg>
          <div class="icon-tooltip">Controls</div>
        </div>
        
      </div>

      <!-- Legend -->
      <div class="legend" id="legendPanel" style="top: 80px;">
        <div class="legend-title">Status Legend</div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--accent-success);"></div>
          <span>UP - Online</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--accent-danger);"></div>
          <span>DOWN - Offline</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--accent-warning);"></div>
          <span>TIMEOUT - Slow Response</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background: var(--text-muted);"></div>
          <span>UNKNOWN - Not Checked</span>
        </div>
      </div>

      <!-- Stats Panel -->
      <div class="stats-panel" id="statsPanel" style="top: 80px;">
        <div class="stats-panel-title">Statistics</div>
        <div class="stat-item">
          <span class="stat-label">Total Nodes:</span>
          <span class="stat-value" id="totalNodes">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Online:</span>
          <span class="stat-value" style="color: var(--accent-success);" id="onlineNodes">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Offline:</span>
          <span class="stat-value" style="color: var(--accent-danger);" id="offlineNodes">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Issues:</span>
          <span class="stat-value" style="color: var(--accent-warning);" id="issueNodes">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Last Update:</span>
          <span class="stat-value" style="font-size: 0.7rem;" id="lastUpdate">-</span>
        </div>
      </div>

      <!-- Controls Panel -->
      <div class="controls-panel" id="controlsPanel" style="bottom: 80px;">
        <div class="control-btn" onclick="zoomIn()" title="Zoom In">
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: var(--text-secondary); fill: none; stroke-width: 2;">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </div>
        <div class="control-btn" onclick="zoomOut()" title="Zoom Out">
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: var(--text-secondary); fill: none; stroke-width: 2;">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </div>
        <div class="control-btn" onclick="resetZoom()" title="Reset Zoom">
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: var(--text-secondary); fill: none; stroke-width: 2;">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
        </div>
      </div>

      <!-- Tooltip -->
      <div class="node-tooltip" id="nodeTooltip"></div>
    </div>

    <!-- Side Panel -->
    <div class="side-panel" id="sidePanel">
      <div class="side-panel-header">
        <div class="side-panel-title" id="sidePanelTitle">Node Details</div>
        <div class="close-btn" onclick="closeSidePanel()">√ó</div>
      </div>
      <div class="side-panel-body" id="sidePanelBody">
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
          Klik node untuk melihat detail lengkap
        </p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      nodeRadius: 20,
      rootRadius: 35,
      verticalSpacing: 150,
      horizontalSpacing: 180,
      linkDistance: 150,
      chargeStrength: -500,
      collisionRadius: 35
    };

    // Status color mapping
    const STATUS_COLORS = {
      'UP': '--accent-success',
      'DOWN': '--accent-danger',
      'TIMEOUT': '--accent-warning',
      'ERROR': '--accent-danger',
      'PARTIAL': '--accent-warning',
      'UNKNOWN': '--text-muted'
    };

    // Global variables
    let ws = null;
    let simulation = null;
    let svg = null;
    let g = null;
    let zoom = null;
    let currentData = null;
    let selectedNode = null;

    // Toggle panel functions
    function toggleLegend() {
      const panel = document.getElementById('legendPanel');
      const btn = document.getElementById('legendBtn');
      panel.classList.toggle('open');
      btn.classList.toggle('active');
    }

    function toggleStats() {
      const panel = document.getElementById('statsPanel');
      const btn = document.getElementById('statsBtn');
      panel.classList.toggle('open');
      btn.classList.toggle('active');
    }

    function toggleControls() {
      const panel = document.getElementById('controlsPanel');
      const btn = document.getElementById('controlsBtn');
      panel.classList.toggle('open');
      btn.classList.toggle('active');
    }

    // WebSocket Connection
    function connectWebSocket() {
      ws = new WebSocket(`ws://${window.location.host}`);
      
      ws.onopen = () => {
        updateConnectionStatus(true);
        console.log('‚úÖ WebSocket connected');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('üì® WebSocket message:', data);
        
        if (data.type === 'monitoring_update' && data.data) {
          updateNodeStatus(data.data);
        } else if (data.type === 'update') {
          loadData();
        }
      };

      ws.onclose = () => {
        updateConnectionStatus(false);
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        updateConnectionStatus(false);
      };
    }

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.className = 'connection-badge connected';
        statusEl.innerHTML = '<span class="status-dot"></span>Terhubung';
      } else {
        statusEl.className = 'connection-badge disconnected';
        statusEl.innerHTML = '<span class="status-dot"></span>Terputus';
      }
    }

    // Initialize D3 Graph
    function initGraph() {
      const container = document.getElementById('tree-graph');
      const width = container.clientWidth;
      const height = container.clientHeight;

      // Create SVG
      svg = d3.select('#tree-graph')
        .attr('width', width)
        .attr('height', height);

      // Create zoom behavior
      zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom);

      // Create main group
      g = svg.append('g');

      // No simulation needed for fixed tree layout
      simulation = null;
    }

    // Load data from API
    async function loadData() {
      try {
        const response = await fetch('/api/urls');
        const result = await response.json();
        const urls = result.data || result;

        // Transform data to graph format
        const graphData = transformToGraphData(urls);
        currentData = graphData;

        // Update graph
        updateGraph(graphData);

        // Update stats
        updateStats(urls);

        // Hide loading
        document.getElementById('loadingOverlay').style.display = 'none';

        console.log('‚úÖ Data loaded:', graphData);
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
      }
    }

    // Transform URLs to graph data
    function transformToGraphData(urls) {
      const nodes = [];
      const links = [];

      // Root node - positioned at top center
      const rootNode = {
        id: 'root',
        name: 'Monitoring System',
        type: 'root',
        status: 'UP',
        isRoot: true,
        x: 0,
        y: 0
      };
      nodes.push(rootNode);

      // Calculate grid layout for child nodes
      const cols = Math.ceil(Math.sqrt(urls.length));
      const rows = Math.ceil(urls.length / cols);

      // Add URL nodes with calculated positions
      urls.forEach((url, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        
        // Center the grid horizontally
        const totalWidth = (cols - 1) * CONFIG.horizontalSpacing;
        const startX = -totalWidth / 2;
        
        const node = {
          id: url._id,
          name: url.name || url.url,
          url: url.url,
          type: 'url',
          status: url.status || 'UNKNOWN',
          responseTime: url.responseTime,
          lastChecked: url.lastChecked,
          httpStatus: url.httpStatus,
          statusMessage: url.statusMessage,
          description: url.description,
          requiresAuth: url.requiresAuth,
          x: startX + (col * CONFIG.horizontalSpacing),
          y: CONFIG.verticalSpacing + (row * CONFIG.verticalSpacing)
        };
        nodes.push(node);

        // Link to root
        links.push({
          source: 'root',
          target: url._id
        });
      });

      return { nodes, links };
    }

    // Update graph visualization
    function updateGraph(data) {
      // Clear existing elements
      g.selectAll('*').remove();

      // Get container dimensions for centering
      const container = document.getElementById('tree-graph');
      const width = container.clientWidth;
      const height = container.clientHeight;
      const centerX = width / 2;
      const centerY = 100; // Root node offset from top

      // Create links
      const link = g.append('g')
        .attr('class', 'links')
        .selectAll('line')
        .data(data.links)
        .enter()
        .append('line')
        .attr('stroke', 'var(--border-color)')
        .attr('stroke-width', 2)
        .attr('stroke-opacity', 0.6)
        .attr('x1', d => {
          const source = data.nodes.find(n => n.id === d.source);
          return centerX + source.x;
        })
        .attr('y1', d => {
          const source = data.nodes.find(n => n.id === d.source);
          return centerY + source.y;
        })
        .attr('x2', d => {
          const target = data.nodes.find(n => n.id === d.target);
          return centerX + target.x;
        })
        .attr('y2', d => {
          const target = data.nodes.find(n => n.id === d.target);
          return centerY + target.y;
        });

      // Create nodes
      const node = g.append('g')
        .attr('class', 'nodes')
        .selectAll('g')
        .data(data.nodes)
        .enter()
        .append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${centerX + d.x},${centerY + d.y})`)
        .call(d3.drag()
          .on('start', function(event, d) { 
            // Raise node to top
            d3.select(this).raise();
            
            // ‚úÖ FIX: Store drag offset to prevent jumping
            // Get current transform
            const currentTransform = d3.zoomTransform(svg.node());
            
            // Calculate offset between mouse position and node center
            const nodeScreenX = (centerX + d.x) * currentTransform.k + currentTransform.x;
            const nodeScreenY = (centerY + d.y) * currentTransform.k + currentTransform.y;
            
            // Store offset
            d.dragOffsetX = event.sourceEvent.clientX - nodeScreenX;
            d.dragOffsetY = event.sourceEvent.clientY - nodeScreenY;
            d.isDragging = true;
            
            // Add visual feedback
            d3.select(this).select('circle')
              .transition()
              .duration(150)
              .attr('stroke-width', 5)
              .attr('r', d.isRoot ? CONFIG.rootRadius + 5 : CONFIG.nodeRadius + 3);
          })
          .on('drag', function(event, d) {
            // ‚úÖ FIX: Calculate new position with offset and zoom
            const currentTransform = d3.zoomTransform(svg.node());
            
            // Apply offset to prevent jumping
            const newScreenX = event.sourceEvent.clientX - d.dragOffsetX;
            const newScreenY = event.sourceEvent.clientY - d.dragOffsetY;
            
            // Convert screen coordinates back to graph coordinates
            const newX = (newScreenX - currentTransform.x) / currentTransform.k;
            const newY = (newScreenY - currentTransform.y) / currentTransform.k;
            
            // Update node position (relative to center)
            d.x = newX - centerX;
            d.y = newY - centerY;
            
            // Update transform
            d3.select(this).attr('transform', `translate(${newX},${newY})`);
            
            // Update connected links
            updateLinks();
          })
          .on('end', function(event, d) {
            d.isDragging = false;
            
            // Remove visual feedback
            d3.select(this).select('circle')
              .transition()
              .duration(150)
              .attr('stroke-width', 3)
              .attr('r', d.isRoot ? CONFIG.rootRadius : CONFIG.nodeRadius);
            
            // Clear offset
            delete d.dragOffsetX;
            delete d.dragOffsetY;
          }));

      // Add circles
      node.append('circle')
        .attr('r', d => d.isRoot ? CONFIG.rootRadius : CONFIG.nodeRadius)
        .attr('fill', d => {
          if (d.isRoot) return 'url(#gradient-primary)';
          const color = STATUS_COLORS[d.status] || STATUS_COLORS['UNKNOWN'];
          return getComputedStyle(document.documentElement).getPropertyValue(
            color.replace('var(', '').replace(')', '')
          );
        })
        .attr('stroke', 'var(--bg-primary)')
        .attr('stroke-width', 3)
        .style('cursor', 'pointer')
        .style('transition', 'all 0.3s ease');

      // Add gradient definitions
      const defs = svg.select('defs').empty() ? svg.append('defs') : svg.select('defs');
      
      if (defs.select('#gradient-primary').empty()) {
        const gradientPrimary = defs.append('linearGradient')
          .attr('id', 'gradient-primary')
          .attr('x1', '0%')
          .attr('y1', '0%')
          .attr('x2', '100%')
          .attr('y2', '100%');
        gradientPrimary.append('stop')
          .attr('offset', '0%')
          .attr('stop-color', '#3b82f6');
        gradientPrimary.append('stop')
          .attr('offset', '100%')
          .attr('stop-color', '#8b5cf6');
      }

      // Add status pulse animation for errors
      node.filter(d => d.status === 'DOWN' || d.status === 'ERROR')
        .append('circle')
        .attr('r', CONFIG.nodeRadius)
        .attr('fill', 'none')
        .attr('stroke', 'var(--accent-danger)')
        .attr('stroke-width', 2)
        .attr('opacity', 0)
        .transition()
        .duration(1500)
        .ease(d3.easeLinear)
        .attr('r', CONFIG.nodeRadius + 15)
        .attr('opacity', 0)
        .on('end', function() {
          d3.select(this).remove();
        });

      // Add labels
      node.append('text')
        .text(d => d.isRoot ? 'üå≥' : getNodeIcon(d.status))
        .attr('text-anchor', 'middle')
        .attr('dy', 5)
        .style('font-size', d => d.isRoot ? '1.5rem' : '1rem')
        .style('pointer-events', 'none')
        .style('user-select', 'none');

      // Add name labels
      node.append('text')
        .text(d => d.name.length > 20 ? d.name.substring(0, 20) + '...' : d.name)
        .attr('text-anchor', 'middle')
        .attr('dy', d => d.isRoot ? CONFIG.rootRadius + 20 : CONFIG.nodeRadius + 16)
        .style('font-size', '0.75rem')
        .style('font-weight', '600')
        .style('fill', 'var(--text-secondary)')
        .style('pointer-events', 'none')
        .style('user-select', 'none');

      // Add event listeners
      node.on('click', (event, d) => {
        // ‚úÖ FIX: Prevent click when dragging
        if (d.isDragging) return;
        
        if (!d.isRoot) {
          hideTooltip(); // ‚úÖ Hide tooltip when showing modal
          showNodeDetails(d);
        }
      })
      .on('mouseover', (event, d) => {
        if (!d.isRoot && !d.isDragging) {
          showTooltip(event, d);
        }
      })
      .on('mouseout', () => {
        hideTooltip(); // ‚úÖ Ensure tooltip disappears
      });

      // Function to update links when dragging
      function updateLinks() {
        link
          .attr('x1', d => {
            const source = data.nodes.find(n => n.id === d.source);
            return centerX + source.x;
          })
          .attr('y1', d => {
            const source = data.nodes.find(n => n.id === d.source);
            return centerY + source.y;
          })
          .attr('x2', d => {
            const target = data.nodes.find(n => n.id === d.target);
            return centerX + target.x;
          })
          .attr('y2', d => {
            const target = data.nodes.find(n => n.id === d.target);
            return centerY + target.y;
          });
      }
    }

    // Get icon based on status
    function getNodeIcon(status) {
      const icons = {
        'UP': '‚úì',
        'DOWN': '‚úï',
        'TIMEOUT': '‚è±',
        'ERROR': '‚ö†',
        'PARTIAL': '‚ö†',
        'UNKNOWN': '?'
      };
      return icons[status] || '?';
    }

    // Update single node status
    function updateNodeStatus(data) {
      const nodeId = data.urlId || data._id;
      const node = currentData.nodes.find(n => n.id === nodeId);
      
      if (node) {
        // Update node data
        node.status = data.status;
        node.responseTime = data.responseTime;
        node.lastChecked = new Date();
        node.httpStatus = data.httpStatus;
        node.statusMessage = data.statusMessage;

        // Update visual
        const nodeElement = d3.select('.nodes')
          .selectAll('g')
          .filter(d => d.id === nodeId);

        nodeElement.select('circle')
          .transition()
          .duration(500)
          .attr('fill', () => {
            const color = STATUS_COLORS[data.status] || STATUS_COLORS['UNKNOWN'];
            return getComputedStyle(document.documentElement).getPropertyValue(
              color.replace('var(', '').replace(')', '')
            );
          });

        nodeElement.select('text')
          .text(getNodeIcon(data.status));

        // Update stats
        updateStatsFromCurrentData();

        // If side panel is open for this node, update it
        if (selectedNode && selectedNode.id === nodeId) {
          showNodeDetails(node);
        }

        console.log('‚úÖ Node updated:', nodeId, data.status);
      }
    }

    // Drag functions (simplified for fixed layout)
    function dragstarted(event, d) {
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      d.fx = null;
      d.fy = null;
    }

    // Zoom controls
    function zoomIn() {
      svg.transition().call(zoom.scaleBy, 1.3);
    }

    function zoomOut() {
      svg.transition().call(zoom.scaleBy, 0.7);
    }

    function resetZoom() {
      const container = document.getElementById('tree-graph');
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      svg.transition().call(
        zoom.transform, 
        d3.zoomIdentity.translate(0, 0).scale(1)
      );
    }

    // Tooltip
    function showTooltip(event, d) {
      const tooltip = document.getElementById('nodeTooltip');
      tooltip.innerHTML = `
        <div class="tooltip-title">${d.name}</div>
        <div class="tooltip-status">Status: <strong>${d.status}</strong></div>
        <div class="tooltip-url">${d.url || ''}</div>
      `;
      tooltip.style.left = (event.pageX + 15) + 'px';
      tooltip.style.top = (event.pageY + 15) + 'px';
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      const tooltip = document.getElementById('nodeTooltip');
      tooltip.classList.remove('visible');
    }

    // Side Panel
    function showNodeDetails(node) {
      selectedNode = node;
      const panel = document.getElementById('sidePanel');
      const title = document.getElementById('sidePanelTitle');
      const body = document.getElementById('sidePanelBody');

      title.textContent = node.name;

      body.innerHTML = `
        <div class="detail-section">
          <div class="detail-section-title">üìä Status</div>
          <div class="detail-item">
            <div class="detail-label">Current Status</div>
            <div class="detail-value">
              <span class="status-badge status-${node.status}">${node.status}</span>
            </div>
          </div>
          ${node.statusMessage ? `
          <div class="detail-item">
            <div class="detail-label">Message</div>
            <div class="detail-value">${node.statusMessage}</div>
          </div>
          ` : ''}
        </div>

        <div class="detail-section">
          <div class="detail-section-title">üîó URL Information</div>
          <div class="detail-item">
            <div class="detail-label">URL</div>
            <div class="detail-value" style="font-size: 0.813rem;">${node.url}</div>
          </div>
          ${node.description ? `
          <div class="detail-item">
            <div class="detail-label">Description</div>
            <div class="detail-value">${node.description}</div>
          </div>
          ` : ''}
        </div>

        <div class="detail-section">
          <div class="detail-section-title">‚ö° Performance</div>
          <div class="detail-item">
            <div class="detail-label">Response Time</div>
            <div class="detail-value">${node.responseTime ? node.responseTime + 'ms' : 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">HTTP Status</div>
            <div class="detail-value">${node.httpStatus || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Last Checked</div>
            <div class="detail-value" style="font-size: 0.813rem;">
              ${node.lastChecked ? new Date(node.lastChecked).toLocaleString('id-ID') : 'Never'}
            </div>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">üîí Security</div>
          <div class="detail-item">
            <div class="detail-label">Requires Authentication</div>
            <div class="detail-value">${node.requiresAuth ? 'Yes ‚úì' : 'No ‚úï'}</div>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <button class="btn btn-primary" style="width: 100%;" onclick="recheckNode('${node.id}')">
            üîÑ Check Now
          </button>
        </div>
      `;

      panel.classList.add('open');
    }

    function closeSidePanel() {
      const panel = document.getElementById('sidePanel');
      panel.classList.remove('open');
      selectedNode = null;
    }

    // Recheck node
    async function recheckNode(nodeId) {
      try {
        const response = await fetch(`/api/urls/${nodeId}/check`, { method: 'POST' });
        if (response.ok) {
          console.log('‚úÖ Node rechecked:', nodeId);
        }
      } catch (error) {
        console.error('‚ùå Error rechecking node:', error);
      }
    }

    // Update stats
    function updateStats(urls) {
      document.getElementById('totalNodes').textContent = urls.length;
      document.getElementById('onlineNodes').textContent = urls.filter(u => u.status === 'UP').length;
      document.getElementById('offlineNodes').textContent = urls.filter(u => u.status === 'DOWN' || u.status === 'ERROR').length;
      document.getElementById('issueNodes').textContent = urls.filter(u => u.status !== 'UP' && u.status !== 'UNKNOWN').length;
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');
    }

    function updateStatsFromCurrentData() {
      const urls = currentData.nodes.filter(n => !n.isRoot);
      updateStats(urls);
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      initGraph();
      connectWebSocket();
      loadData();

      // Auto refresh every 30 seconds
      setInterval(loadData, 30000);
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (currentData) {
        updateGraph(currentData);
      }
    });

    // Fullscreen toggle
    function toggleFullscreen() {
      const elem = document.documentElement;
      const icon = document.getElementById('fullscreenIcon');

      if (!document.fullscreenElement) {
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.mozRequestFullScreen) { // Firefox
          elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) { // Chrome, Safari and Opera
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { // IE/Edge
          elem.msRequestFullscreen();
        }
        icon.innerHTML = '<path d="M3 8V5a2 2 0 0 1 2-2h3m10 0h3a2 2 0 0 1 2 2v3m0 10v3a2 2 0 0 1-2 2h-3M8 21H5a2 2 0 0 1-2-2v-3"/>';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) { // Firefox
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { // IE/Edge
          document.msExitFullscreen();
        }
        icon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
      }
    }
  </script>
</body>
</html>
